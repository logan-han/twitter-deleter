name: Build and Deploy
env:
  AWS_DEFAULT_REGION: "ap-southeast-2"
on:
  push:
    branches: [ main ]

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: git clone the repo
        uses: actions/checkout@v2

      - name: prep nodeJS
        uses: actions/setup-node@v1
        with:
          node-version: '12'

      - name: Install Serverless Framework
        run: npm install -g serverless

      - name: Inject Secrets
        env :
          CONSUMER_KEY: ${{ secrets.CONSUMER_KEY }}
          CONSUMER_SECRET: ${{ secrets.CONSUMER_SECRET }}
        run : |
          sed -i "s/CONSUMER_KEY/$env:CONSUMER_KEY/g" config.js
          sed -i "s/CONSUMER_SECRET/$env:CONSUMER_SECRET/g" config.js

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id     :  ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key :  ${{ secrets.AWS_SECRET_KEY }}
          aws-region            :  ${{ env.AWS_DEFAULT_REGION }}

     - name: Install NPM dependencies
        run: npm install
        
     - name: Deploy Lambda functions
        run: sls deploy -s prod
